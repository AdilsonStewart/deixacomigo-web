import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { db } from '../firebase/firebase-client';
import { collection, getDocs, orderBy, query } from 'firebase/firestore';
import './PainelAdmin.css';

const PainelAdmin = () => {
  const navigate = useNavigate();
  const [audios, setAudios] = useState([]);
  const [agendamentos, setAgendamentos] = useState([]);
  const [loading, setLoading] = useState(true);

  // Buscar todos os Ã¡udios do Firebase
  const fetchAudios = async () => {
    try {
      const q = query(collection(db, 'audios'), orderBy('dataCriacao', 'desc'));
      const querySnapshot = await getDocs(q);
      
      const audiosList = [];
      querySnapshot.forEach((doc) => {
        audiosList.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      setAudios(audiosList);
    } catch (error) {
      console.error('Erro ao buscar Ã¡udios:', error);
    }
  };

  // Buscar agendamentos do localStorage
  const fetchAgendamentos = () => {
    try {
      const lastAgendamento = localStorage.getItem('lastAgendamento');
      const agendamentosList = lastAgendamento ? [JSON.parse(lastAgendamento)] : [];
      setAgendamentos(agendamentosList);
    } catch (error) {
      console.error('Erro ao buscar agendamentos:', error);
    }
  };

  useEffect(() => {
    const loadData = async () => {
      await fetchAudios();
      fetchAgendamentos();
      setLoading(false);
    };
    loadData();
  }, []);

  // Copiar link para Ã¡rea de transferÃªncia
  const copyToClipboard = (url) => {
    navigator.clipboard.writeText(url)
      .then(() => alert('âœ… Link copiado!'))
      .catch(err => console.error('Erro ao copiar:', err));
  };

  // Formatar data
  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('pt-BR');
  };

  // Formatar data e hora
  const formatDateTime = (dateString) => {
    return new Date(dateString).toLocaleString('pt-BR');
  };

  if (loading) {
    return (
      <div className="painel-admin-container">
        <div className="loading">Carregando...</div>
      </div>
    );
  }

  return (
    <div className="painel-admin-container">
      <div className="painel-header">
        <h1>ğŸ›ï¸ Painel Administrativo</h1>
        <p>Gerencie links de mensagens e agendamentos</p>
        <button className="btn-voltar" onClick={() => navigate('/')}>
          â† Voltar para Home
        </button>
      </div>

      {/* ESTATÃSTICAS */}
      <div className="stats-grid">
        <div className="stat-card">
          <h3>ğŸ§ Ãudios</h3>
          <p className="stat-number">{audios.length}</p>
          <p>Total gravados</p>
        </div>
        <div className="stat-card">
          <h3>ğŸ“… Agendamentos</h3>
          <p className="stat-number">{agendamentos.length}</p>
          <p>Para enviar</p>
        </div>
      </div>

      {/* LISTA DE LINKS DE MENSAGENS */}
      <div className="links-section">
        <h2>ğŸ”— Links de Mensagens Gerados</h2>
        
        {audios.length === 0 ? (
          <div className="empty-state">
            <p>Nenhuma mensagem gerada ainda</p>
          </div>
        ) : (
          <div className="links-table">
            <div className="table-header">
              <div className="col-data">Data CriaÃ§Ã£o</div>
              <div className="col-link">Link da Mensagem</div>
              <div className="col-entrega">Data Entrega</div>
              <div className="col-acoes">AÃ§Ãµes</div>
            </div>
            
            {audios.map((audio) => {
              // Encontrar agendamento correspondente a este Ã¡udio
              const agendamentoCorrespondente = agendamentos.find(
                ag => ag.recordingId === audio.id
              );
              
              return (
                <div key={audio.id} className="table-row">
                  <div className="col-data">
                    {formatDateTime(audio.dataCriacao)}
                  </div>
                  
                  <div className="col-link">
                    <div className="link-url">
                      {audio.arquivoUrl.substring(0, 50)}...
                    </div>
                  </div>
                  
                  <div className="col-entrega">
                    {agendamentoCorrespondente ? (
                      <div>
                        <strong>{agendamentoCorrespondente.date}</strong>
                        <br />
                        <small>{agendamentoCorrespondente.time}</small>
                        <br />
                        <small>Para: {agendamentoCorrespondente.nome}</small>
                      </div>
                    ) : (
                      <span className="sem-agendamento">NÃ£o agendado</span>
                    )}
                  </div>
                  
                  <div className="col-acoes">
                    <button 
                      className="btn-ouvir"
                      onClick={() => window.open(audio.arquivoUrl, '_blank')}
                    >
                      â–¶ï¸ Ouvir
                    </button>
                    
                    <button 
                      className="btn-copiar"
                      onClick={() => copyToClipboard(audio.arquivoUrl)}
                    >
                      ğŸ“‹ Copiar
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* AGENDAMENTOS */}
      <div className="agendamentos-section">
        <h2>ğŸ“… PrÃ³ximas Entregas</h2>
        
        {agendamentos.length === 0 ? (
          <div className="empty-state">
            <p>Nenhum agendamento encontrado</p>
          </div>
        ) : (
          <div className="agendamentos-grid">
            {agendamentos.map((agendamento, index) => (
              <div key={index} className="agendamento-card">
                <div className="agendamento-header">
                  <h3>Entrega #{index + 1}</h3>
                  <span className="agendamento-status">ğŸŸ¢ Pendente</span>
                </div>
                
                <div className="agendamento-info">
                  <div className="info-group">
                    <label>ğŸ‘¤ DestinatÃ¡rio:</label>
                    <p>{agendamento.nome}</p>
                  </div>
                  
                  <div className="info-group">
                    <label>ğŸ“ Telefone:</label>
                    <p>{agendamento.telefone}</p>
                  </div>
                  
                  <div className="info-group">
                    <label>ğŸ“… Data Entrega:</label>
                    <p><strong>{agendamento.date}</strong></p>
                  </div>
                  
                  <div className="info-group">
                    <label>â° HorÃ¡rio:</label>
                    <p>{agendamento.time}</p>
                  </div>
                  
                  {agendamento.instructions && (
                    <div className="info-group">
                      <label>ğŸ“ ObservaÃ§Ãµes:</label>
                      <p>{agendamento.instructions}</p>
                    </div>
                  )}
                </div>
                
                <div className="agendamento-actions">
                  <button className="btn-enviar">
                    ğŸ“¤ Enviar Agora
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

    </div>
  );
};

export default PainelAdmin;
